<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Permissions - HRMS</title>
    <!-- Enhanced CSS -->
    <link rel="stylesheet" href="../assets/css/enhanced.css">
    <link rel="stylesheet" href="../assets/css/dashboard-enhanced.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>HRMS</h2>
                <span class="role-badge" id="userRole">Admin</span>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span>üìä</span> Dashboard
                </a>
                <a href="users.html" class="nav-item">
                    <span>üë•</span> Users
                </a>
                <a href="permissions.html" class="nav-item active">
                    <span>üîê</span> Permissions
                </a>
                <a href="templates.html" class="nav-item">
                    <span>üìã</span> Templates
                </a>
                <a href="requirements.html" class="nav-item">
                    <span>üìù</span> Requirements
                </a>
                <a href="candidates.html" class="nav-item">
                    <span>üë§</span> Candidates
                </a>
                <a href="tests.html" class="nav-item">
                    <span>‚úèÔ∏è</span> Tests
                </a>
                <a href="reports.html" class="nav-item">
                    <span>üìà</span> Reports
                </a>
            </nav>
            <div class="sidebar-footer">
                <button class="btn btn-secondary btn-block" onclick="logout()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="top-bar">
                <div class="top-bar-left">
                    <button class="btn-icon" id="toggleSidebar">‚ò∞</button>
                    <h1>Permission Settings</h1>
                </div>
                <div class="top-bar-right">
                    <span class="user-name" id="userName">Admin User</span>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area">
                <!-- Role Tabs -->
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchRole('Admin')">Admin</button>
                    <button class="tab-btn" onclick="switchRole('EA')">EA</button>
                    <button class="tab-btn" onclick="switchRole('HR')">HR</button>
                </div>

                <!-- Permissions Card -->
                <div class="card">
                    <div class="card-header">
                        <h3>Permissions for <span id="currentRole">Admin</span></h3>
                        <button class="btn btn-primary" onclick="savePermissions()">Save Changes</button>
                    </div>
                    <div class="card-body">
                        <div id="permissionsContainer">
                            <div class="loading-spinner"></div>
                            Loading permissions...
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../config.js"></script>
    <script src="../assets/js/common.js"></script>
    <script src="../assets/js/admin-common.js"></script>
    <script>
        let currentRole = 'Admin';
        let permissions = {};

        const modules = [
            { id: 'dashboard', name: 'Dashboard', pages: ['View Dashboard'] },
            { id: 'users', name: 'User Management', pages: ['View Users', 'Add User', 'Edit User', 'Delete User'] },
            { id: 'permissions', name: 'Permissions', pages: ['View Permissions', 'Edit Permissions'] },
            { id: 'templates', name: 'Job Templates', pages: ['View Templates', 'Add Template', 'Edit Template', 'Delete Template'] },
            { id: 'requirements', name: 'Requirements', pages: ['Raise Requirement', 'View Requirements', 'Edit Requirement', 'Review Requirement'] },
            { id: 'jobPosting', name: 'Job Posting', pages: ['View Postings', 'Post Job', 'Update Posting'] },
            { id: 'candidates', name: 'Candidates', pages: ['View Candidates', 'Upload CV', 'Shortlist', 'Call', 'Owner Discussion', 'Schedule Interview', 'Walk-in Management', 'Change Role'] },
            { id: 'tests', name: 'Tests', pages: ['View Test Marks', 'Update Tally Marks', 'Update Voice Marks', 'Update Excel Marks', 'Update HR Interview Marks'] },
            { id: 'reports', name: 'Reports', pages: ['View Reports', 'Export Data'] }
        ];

        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadPermissions();
        });

        async function loadPermissions() {
            try {
                const response = await apiCall('getPermissions', { role: currentRole });
                permissions = response.permissions || {};
                renderPermissions();
            } catch (error) {
                console.error('Error loading permissions:', error);
                document.getElementById('permissionsContainer').innerHTML = `
                    <p class="text-danger">Failed to load permissions</p>
                `;
            }
        }

        function renderPermissions() {
            const container = document.getElementById('permissionsContainer');
            
            container.innerHTML = modules.map(module => `
                <div class="permission-module">
                    <div class="module-header">
                        <h4>${module.name}</h4>
                        <label class="switch">
                            <input type="checkbox" 
                                   id="module_${module.id}" 
                                   ${isModuleEnabled(module.id) ? 'checked' : ''}
                                   onchange="toggleModule('${module.id}')">
                            <span class="slider"></span>
                        </label>
                    </div>
                    <div class="module-pages" id="pages_${module.id}">
                        ${module.pages.map(page => `
                            <label class="checkbox-label">
                                <input type="checkbox" 
                                       data-module="${module.id}"
                                       data-page="${page}"
                                       ${isPageEnabled(module.id, page) ? 'checked' : ''}
                                       onchange="updatePermission('${module.id}', '${page}', this.checked)">
                                <span>${page}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function isModuleEnabled(moduleId) {
            return permissions[moduleId] && Object.values(permissions[moduleId]).some(v => v === true);
        }

        function isPageEnabled(moduleId, page) {
            return permissions[moduleId] && permissions[moduleId][page] === true;
        }

        function toggleModule(moduleId) {
            const isChecked = document.getElementById(`module_${moduleId}`).checked;
            const module = modules.find(m => m.id === moduleId);
            
            if (!permissions[moduleId]) {
                permissions[moduleId] = {};
            }

            module.pages.forEach(page => {
                permissions[moduleId][page] = isChecked;
            });

            renderPermissions();
        }

        function updatePermission(moduleId, page, enabled) {
            if (!permissions[moduleId]) {
                permissions[moduleId] = {};
            }
            permissions[moduleId][page] = enabled;
        }

        function switchRole(role) {
            currentRole = role;
            document.getElementById('currentRole').textContent = role;
            
            // Update tab active state
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent === role) {
                    btn.classList.add('active');
                }
            });

            loadPermissions();
        }

        async function savePermissions() {
            try {
                await apiCall('updatePermissions', {
                    role: currentRole,
                    permissions: permissions
                });
                showToast('Permissions updated successfully', 'success');
            } catch (error) {
                showToast('Failed to update permissions', 'error');
            }
        }
    </script>

    <style>
        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            color: #6b7280;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            color: var(--primary-color);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .permission-module {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .module-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .module-header h4 {
            margin: 0;
            font-size: 1.1rem;
        }

        .module-pages {
            padding: 1rem 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.75rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .checkbox-label:hover {
            background: #f9fafb;
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
</body>
</html>
